FROM registry.fedoraproject.org/fedora:latest

# Update & install general dependencies
RUN dnf install -y \
    python3 \
    python3-pip \
    python3-virtualenv \
    git \
    wget \
    curl \
    unzip \
    gcc \
    gcc-c++ \
    make \
    && dnf clean all

# Create global venv for all users
RUN python3 -m venv /opt/llm-venv
ENV PATH="/opt/llm-venv/bin:${PATH}"

# Install shared ML tooling (fixed PyTorch version)
RUN pip install --upgrade pip && \
    pip install \
        torch==2.9.1 \
        transformers \
        datasets \
        accelerate \
        peft \
        bitsandbytes \
        sentencepiece \
        evaluate \
        huggingface_hub \
        safetensors

# Create directory for shared scripts
RUN mkdir -p /opt/llm-setup

# Copy scripts from build context
COPY scripts/ /opt/llm-setup/

# Make scripts executable
RUN chmod -R +x /opt/llm-setup/

# Automatically activate venv for shell sessions
RUN echo 'source /opt/llm-venv/bin/activate' >> /etc/bashrc